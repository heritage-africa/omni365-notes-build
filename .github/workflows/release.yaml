name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
#
jobs:
  release:
    # Only trigger when commit message contains --release
    if: contains(github.event.head_commit.message, '--release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (1) Read Node/NPM versions exactly like node.yml
      - name: Read node & npm versions
        id: versions
        uses: skjnldsv/read-package-engines-version-actions@v3
        with:
          fallbackNode: '^20'
          fallbackNpm: '^10'

      # (2) Setup Nextcloud environment + Krankerl
      - name: Setup Nextcloud environment
        uses: ChristophWurst/setup-nextcloud@v0.3.2
        with:
          node-version: ${{ steps.versions.outputs.nodeVersion }}
          npm-version: ${{ steps.versions.outputs.npmVersion }}
          tools: "krankerl"

      # (3) Install + Build EXACTLY like node.yml
      - name: Install dependencies & build
        env:
          CYPRESS_INSTALL_BINARY: 0
          PUPPETEER_SKIP_DOWNLOAD: true
        run: |
          npm ci
          npm run build --if-present

      # (4) Package with Krankerl (Nextcloud standard)
      - name: Package app
        run: krankerl package

      # (5) Create GitHub Release and upload tar.gz
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.FASECRET }}
        run: |
          gh release create latest ./build/artifacts/tasks.tar.gz \
            --title "release" \
            --notes "Automated build & packaging from main branch."
